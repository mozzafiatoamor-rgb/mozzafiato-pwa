<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#fbbc04">
  <title>Registrar Ventas - Mozzafiato</title>
  <script src="config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #fbbc04 0%, #f57c00 100%);
      min-height: 100vh;
      padding: 15px;
      color: #333;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      align-items: center;
      color: white;
      margin-bottom: 20px;
      padding: 15px 0;
    }
    
    .back-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      margin-right: 15px;
    }
    
    .header h1 {
      font-size: 24px;
      flex: 1;
    }
    
    .form-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
    }
    
    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: 0.3s;
      font-family: inherit;
    }
    
    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #fbbc04;
      background: #fff8e1;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .stock-info {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 10px;
      margin-top: 8px;
      font-size: 13px;
      display: none;
    }
    
    .stock-info.show {
      display: block;
    }
    
    .stock-ok {
      color: #28a745;
      font-weight: bold;
    }
    
    .stock-low {
      color: #ffc107;
      font-weight: bold;
    }
    
    .stock-out {
      color: #dc3545;
      font-weight: bold;
    }
    
    .btn {
      width: 100%;
      padding: 18px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #fbbc04 0%, #f57c00 100%);
      color: white;
      margin-bottom: 10px;
    }
    
    .btn-secondary {
      background: white;
      color: #fbbc04;
      border: 2px solid #fbbc04;
    }
    
    .pendientes {
      background: white;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 15px;
      display: none;
    }
    
    .pendientes.show {
      display: block;
    }
    
    .pendientes h3 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .contador-badge {
      background: #fbbc04;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 14px;
    }
    
    .pendiente-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 10px;
      border-left: 4px solid #fbbc04;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pendiente-info {
      flex: 1;
    }
    
    .pendiente-nombre {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .pendiente-detalles {
      font-size: 13px;
      color: #666;
    }
    
    .btn-eliminar {
      background: #ea4335;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    
    .alert {
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      font-size: 14px;
      display: none;
    }
    
    .alert.show {
      display: block;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
    
    .info-box {
      background: #fff8e1;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #f57c00;
      border-left: 4px solid #fbbc04;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="back-btn" onclick="volver()">‚Üê</button>
      <h1>üí∞ Registrar Ventas</h1>
    </div>
    
    <div class="info-box">
      üìÖ <strong>Hoy:</strong> <span id="fechaHoy"></span> | Validaci√≥n autom√°tica de stock
    </div>
    
    <div class="alert" id="alert"></div>
    
    <div class="form-card">
      <form id="formVentas">
        <div class="form-group">
          <label>üè∑Ô∏è Categor√≠a *</label>
          <select id="categoria" required>
            <option value="">Seleccionar categor√≠a...</option>
            <option value="Prote√≠na">üçñ Prote√≠na</option>
            <option value="Salsa">üçù Salsa</option>
            <option value="Pasta">üçú Pasta</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>üì¶ Producto *</label>
          <select id="producto" required disabled>
            <option value="">Primero selecciona categor√≠a...</option>
          </select>
          <div class="stock-info" id="stockInfo"></div>
        </div>
        
        <div class="form-group">
          <label>üî¢ Cantidad Vendida *</label>
          <input type="number" id="cantidad" min="1" placeholder="Ej: 5" required>
        </div>
        
        <div class="form-group">
          <label>üë§ Vendedor *</label>
          <input type="text" id="vendedor" placeholder="Nombre del vendedor" required list="vendList">
          <datalist id="vendList"></datalist>
        </div>
        
        <div class="form-group">
          <label>üìù Notas (Opcional)</label>
          <textarea id="notas" placeholder="Observaciones adicionales..."></textarea>
        </div>
        
        <button type="submit" class="btn btn-secondary">‚ûï Agregar a Lista</button>
      </form>
    </div>
    
    <div class="pendientes" id="pendientes">
      <h3>
        üìã Pendientes por Guardar
        <span class="contador-badge" id="contador">0</span>
      </h3>
      <div id="listaPendientes"></div>
      <button class="btn btn-primary" onclick="guardarTodos()">üíæ Guardar Todo</button>
    </div>
  </div>
  
  <script>
    const productos = {
      'Prote√≠na': ['Pollo', 'Arrachera', 'Carne de Hamburguesa', 'Salm√≥n', 'Camar√≥n'],
      'Salsa': ['Alfredo', 'Carbonara', 'Bolo√±esa', 'Matriciana', 'Cuatro Quesos', 'Portobelo'],
      'Pasta': ['Fettuccini', 'Fusilli', 'Lasa√±a']
    };
    
    // Stocks simulados (luego se conectar√° con Google Sheets)
    const stocksSimulados = {
      'Pollo': 45, 'Arrachera': 30, 'Carne de Hamburguesa': 50, 'Salm√≥n': 8, 'Camar√≥n': 15,
      'Alfredo': 60, 'Carbonara': 55, 'Bolo√±esa': 40, 'Matriciana': 25, 'Cuatro Quesos': 35, 'Portobelo': 20,
      'Fettuccini': 80, 'Fusilli': 70, 'Lasa√±a': 12
    };
    
    let stocks = {...stocksSimulados};
    let registrosPendientes = JSON.parse(localStorage.getItem('ventas_pendiente')) || [];
    
    // Mostrar fecha actual
    const hoy = new Date();
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('fechaHoy').textContent = hoy.toLocaleDateString('es-MX', opciones);
    
    // Cargar vendedores anteriores
    const vendedoresGuardados = JSON.parse(localStorage.getItem('vendedores')) || [];
    const vendList = document.getElementById('vendList');
    vendedoresGuardados.forEach(v => {
      const option = document.createElement('option');
      option.value = v;
      vendList.appendChild(option);
    });
    
    // Cambio de categor√≠a
    document.getElementById('categoria').addEventListener('change', function() {
      const categoria = this.value;
      const selectProducto = document.getElementById('producto');
      selectProducto.innerHTML = '<option value="">Seleccionar producto...</option>';
      document.getElementById('stockInfo').classList.remove('show');
      
      if (categoria && productos[categoria]) {
        productos[categoria].forEach(prod => {
          const option = document.createElement('option');
          const stock = stocks[prod] || 0;
          option.value = prod;
          option.textContent = `${prod} (Stock: ${stock})`;
          if (stock === 0) option.disabled = true;
          selectProducto.appendChild(option);
        });
        selectProducto.disabled = false;
      } else {
        selectProducto.disabled = true;
      }
    });
    
    // Cambio de producto - mostrar stock
    document.getElementById('producto').addEventListener('change', function() {
      const producto = this.value;
      const stockInfo = document.getElementById('stockInfo');
      const cantInput = document.getElementById('cantidad');
      
      if (producto) {
        const stock = stocks[producto] || 0;
        stockInfo.classList.add('show');
        
        if (stock === 0) {
          stockInfo.innerHTML = '‚õî <span class="stock-out">AGOTADO - No disponible</span>';
          cantInput.disabled = true;
          cantInput.value = '';
        } else if (stock < 10) {
          stockInfo.innerHTML = `‚ö†Ô∏è <span class="stock-low">Stock bajo: ${stock} disponibles</span>`;
          cantInput.disabled = false;
          cantInput.max = stock;
        } else {
          stockInfo.innerHTML = `‚úÖ <span class="stock-ok">Disponible: ${stock} porciones</span>`;
          cantInput.disabled = false;
          cantInput.max = stock;
        }
      } else {
        stockInfo.classList.remove('show');
      }
    });
    
    // Submit del formulario
    document.getElementById('formVentas').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const producto = document.getElementById('producto').value;
      const cantidad = parseInt(document.getElementById('cantidad').value);
      const stock = stocks[producto] || 0;
      
      if (cantidad > stock) {
        mostrarAlerta(`‚ùå Stock insuficiente. Solo hay ${stock} disponibles`, 'error');
        return;
      }
      
      const registro = {
        categoria: document.getElementById('categoria').value,
        producto: producto,
        cantidad: cantidad,
        vendedor: document.getElementById('vendedor').value,
        notas: document.getElementById('notas').value
      };
      
      registrosPendientes.push(registro);
      localStorage.setItem('ventas_pendiente', JSON.stringify(registrosPendientes));
      
      // Actualizar stock temporal
      stocks[producto] -= cantidad;
      
      // Guardar vendedor
      if (!vendedoresGuardados.includes(registro.vendedor)) {
        vendedoresGuardados.push(registro.vendedor);
        localStorage.setItem('vendedores', JSON.stringify(vendedoresGuardados));
      }
      
      actualizarLista();
      
      // Limpiar solo cantidad y notas
      document.getElementById('cantidad').value = '';
      document.getElementById('notas').value = '';
      
      // Actualizar info de stock
      document.getElementById('producto').dispatchEvent(new Event('change'));
      
      mostrarAlerta('‚úÖ Venta agregada a la lista', 'success');
    });
    
    function actualizarLista() {
      const pendientesDiv = document.getElementById('pendientes');
      const lista = document.getElementById('listaPendientes');
      const contador = document.getElementById('contador');
      
      if (registrosPendientes.length > 0) {
        pendientesDiv.classList.add('show');
        contador.textContent = registrosPendientes.length;
        
        lista.innerHTML = registrosPendientes.map((r, i) => `
          <div class="pendiente-item">
            <div class="pendiente-info">
              <div class="pendiente-nombre">${r.producto}</div>
              <div class="pendiente-detalles">${r.cantidad} porciones | ${r.vendedor}</div>
            </div>
            <button class="btn-eliminar" onclick="eliminar(${i})">‚úï</button>
          </div>
        `).join('');
      } else {
        pendientesDiv.classList.remove('show');
      }
    }
    
    function eliminar(index) {
      const reg = registrosPendientes[index];
      // Devolver al stock
      stocks[reg.producto] += reg.cantidad;
      
      registrosPendientes.splice(index, 1);
      localStorage.setItem('ventas_pendiente', JSON.stringify(registrosPendientes));
      actualizarLista();
      
      // Actualizar select de producto si est√° visible
      const productoActual = document.getElementById('producto').value;
      if (productoActual === reg.producto) {
        document.getElementById('producto').dispatchEvent(new Event('change'));
      }
      
      mostrarAlerta('‚ùå Venta eliminada de la lista', 'error');
    }
    
    async function guardarTodos() {
      if (registrosPendientes.length === 0) return;
      
      mostrarAlerta('‚è≥ Guardando ventas...', 'success');
      
      // Guardar en localStorage temporal
      const ventasGuardadas = JSON.parse(localStorage.getItem('ventas_guardadas')) || [];
      registrosPendientes.forEach(r => {
        r.fecha = new Date().toISOString();
        r.id = 'VENTA-' + Date.now() + '-' + Math.random();
        ventasGuardadas.push(r);
      });
      
      localStorage.setItem('ventas_guardadas', JSON.stringify(ventasGuardadas));
      
      // Limpiar pendientes
      registrosPendientes = [];
      localStorage.removeItem('ventas_pendiente');
      
      // Resetear stocks para pr√≥xima sesi√≥n
      stocks = {...stocksSimulados};
      
      // Actualizar UI
      actualizarLista();
      document.getElementById('formVentas').reset();
      document.getElementById('producto').disabled = true;
      document.getElementById('stockInfo').classList.remove('show');
      
      mostrarAlerta('‚úÖ ¬°Ventas guardadas exitosamente!', 'success');
      
      // Sincronizaci√≥n en segundo plano
      if ('serviceWorker' in navigator && 'sync' in navigator.serviceWorker) {
        const registration = await navigator.serviceWorker.ready;
        await registration.sync.register('sync-data');
      }
    }
    
    function mostrarAlerta(mensaje, tipo) {
      const alert = document.getElementById('alert');
      alert.textContent = mensaje;
      alert.className = `alert alert-${tipo} show`;
      setTimeout(() => {
        alert.classList.remove('show');
      }, 3000);
    }
    
    function volver() {
      window.location.href = 'index.html';
    }
    
    // Inicializar lista al cargar
    actualizarLista();
  </script>
</body>
</html>
