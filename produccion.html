<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#34a853">
  <title>Registrar Producci√≥n - Mozzafiato</title>
  <script src="config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #34a853 0%, #2e7d32 100%);
      min-height: 100vh;
      padding: 15px;
      color: #333;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      align-items: center;
      color: white;
      margin-bottom: 20px;
      padding: 15px 0;
    }
    
    .back-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      margin-right: 15px;
    }
    
    .header h1 {
      font-size: 24px;
      flex: 1;
    }
    
    .form-card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
    }
    
    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: 0.3s;
      font-family: inherit;
    }
    
    .form-group select:focus,
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #34a853;
      background: #f1f8f4;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .btn {
      width: 100%;
      padding: 18px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #34a853 0%, #2e7d32 100%);
      color: white;
      margin-bottom: 10px;
    }
    
    .btn-secondary {
      background: white;
      color: #34a853;
      border: 2px solid #34a853;
    }
    
    .pendientes {
      background: white;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 15px;
      display: none;
    }
    
    .pendientes.show {
      display: block;
    }
    
    .pendientes h3 {
      font-size: 16px;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .contador-badge {
      background: #34a853;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 14px;
    }
    
    .pendiente-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 10px;
      border-left: 4px solid #34a853;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pendiente-info {
      flex: 1;
    }
    
    .pendiente-nombre {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .pendiente-detalles {
      font-size: 13px;
      color: #666;
    }
    
    .btn-eliminar {
      background: #ea4335;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
    }
    
    .alert {
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      font-size: 14px;
      display: none;
    }
    
    .alert.show {
      display: block;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
    
    .info-box {
      background: #e3f2fd;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #1565c0;
      border-left: 4px solid #4285f4;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="back-btn" onclick="volver()">‚Üê</button>
      <h1>‚ûï Registrar Producci√≥n</h1>
    </div>
    
    <div class="info-box">
      üìÖ <strong>Hoy:</strong> <span id="fechaHoy"></span> | Puedes agregar varios productos antes de guardar
    </div>
    
    <div class="alert" id="alert"></div>
    
    <div class="form-card">
      <form id="formProduccion">
        <div class="form-group">
          <label>‚è∞ Turno *</label>
          <select id="turno" required>
            <option value="">Seleccionar turno...</option>
            <option value="Matutino">üåÖ Matutino</option>
            <option value="Vespertino">üåÜ Vespertino</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>üè∑Ô∏è Categor√≠a *</label>
          <select id="categoria" required>
            <option value="">Seleccionar categor√≠a...</option>
            <option value="Prote√≠na">üçñ Prote√≠na</option>
            <option value="Salsa">üçù Salsa</option>
            <option value="Pasta">üçú Pasta</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>üì¶ Producto *</label>
          <select id="producto" required disabled>
            <option value="">Primero selecciona categor√≠a...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>üî¢ Cantidad (porciones) *</label>
          <input type="number" id="cantidad" min="1" placeholder="Ej: 50" required>
        </div>
        
        <div class="form-group">
          <label>üë§ Responsable *</label>
          <input type="text" id="responsable" placeholder="Nombre del responsable" required list="respList">
          <datalist id="respList"></datalist>
        </div>
        
        <div class="form-group">
          <label>üìù Notas (Opcional)</label>
          <textarea id="notas" placeholder="Observaciones adicionales..."></textarea>
        </div>
        
        <button type="submit" class="btn btn-secondary">‚ûï Agregar a Lista</button>
      </form>
    </div>
    
    <div class="pendientes" id="pendientes">
      <h3>
        üìã Pendientes por Guardar
        <span class="contador-badge" id="contador">0</span>
      </h3>
      <div id="listaPendientes"></div>
      <button class="btn btn-primary" id="btnGuardar" onclick="guardarTodos()">üíæ Guardar Todo</button>
    </div>
  </div>
  
  <script>
    const productos = {
      'Prote√≠na': ['Pollo', 'Arrachera', 'Carne de Hamburguesa', 'Salm√≥n', 'Camar√≥n'],
      'Salsa': ['Alfredo', 'Carbonara', 'Bolo√±esa', 'Matriciana', 'Cuatro Quesos', 'Portobelo'],
      'Pasta': ['Fettuccini', 'Fusilli', 'Lasa√±a']
    };
    
    let registrosPendientes = JSON.parse(localStorage.getItem('produccion_pendiente')) || [];
    
    // Mostrar fecha actual
    const hoy = new Date();
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('fechaHoy').textContent = hoy.toLocaleDateString('es-MX', opciones);
    
    // Cargar responsables anteriores
    const responsablesGuardados = JSON.parse(localStorage.getItem('responsables')) || [];
    const respList = document.getElementById('respList');
    responsablesGuardados.forEach(r => {
      const option = document.createElement('option');
      option.value = r;
      respList.appendChild(option);
    });
    
    // Cambio de categor√≠a
    document.getElementById('categoria').addEventListener('change', function() {
      const categoria = this.value;
      const selectProducto = document.getElementById('producto');
      selectProducto.innerHTML = '<option value="">Seleccionar producto...</option>';
      
      if (categoria && productos[categoria]) {
        productos[categoria].forEach(prod => {
          const option = document.createElement('option');
          option.value = prod;
          option.textContent = prod;
          selectProducto.appendChild(option);
        });
        selectProducto.disabled = false;
      } else {
        selectProducto.disabled = true;
      }
    });
    
    // Submit del formulario
    document.getElementById('formProduccion').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const registro = {
        turno: document.getElementById('turno').value,
        categoria: document.getElementById('categoria').value,
        producto: document.getElementById('producto').value,
        cantidad: parseInt(document.getElementById('cantidad').value),
        responsable: document.getElementById('responsable').value,
        notas: document.getElementById('notas').value
      };
      
      registrosPendientes.push(registro);
      localStorage.setItem('produccion_pendiente', JSON.stringify(registrosPendientes));
      
      // Guardar responsable
      if (!responsablesGuardados.includes(registro.responsable)) {
        responsablesGuardados.push(registro.responsable);
        localStorage.setItem('responsables', JSON.stringify(responsablesGuardados));
      }
      
      actualizarLista();
      
      // Limpiar solo cantidad y notas
      document.getElementById('cantidad').value = '';
      document.getElementById('notas').value = '';
      
      mostrarAlerta('‚úÖ Producto agregado a la lista', 'success');
    });
    
    function actualizarLista() {
      const pendientesDiv = document.getElementById('pendientes');
      const lista = document.getElementById('listaPendientes');
      const contador = document.getElementById('contador');
      
      if (registrosPendientes.length > 0) {
        pendientesDiv.classList.add('show');
        contador.textContent = registrosPendientes.length;
        
        lista.innerHTML = registrosPendientes.map((r, i) => `
          <div class="pendiente-item">
            <div class="pendiente-info">
              <div class="pendiente-nombre">${r.producto}</div>
              <div class="pendiente-detalles">${r.cantidad} porciones | ${r.turno} | ${r.responsable}</div>
            </div>
            <button class="btn-eliminar" onclick="eliminar(${i})">‚úï</button>
          </div>
        `).join('');
      } else {
        pendientesDiv.classList.remove('show');
      }
    }
    
    function eliminar(index) {
      registrosPendientes.splice(index, 1);
      localStorage.setItem('produccion_pendiente', JSON.stringify(registrosPendientes));
      actualizarLista();
      mostrarAlerta('‚ùå Producto eliminado de la lista', 'error');
    }
    
    async function guardarTodos() {
      if (registrosPendientes.length === 0) {
        mostrarAlerta('‚ö†Ô∏è No hay productos para guardar', 'error');
        return;
      }
      
      const btnGuardar = document.getElementById('btnGuardar');
      btnGuardar.disabled = true;
      btnGuardar.textContent = '‚è≥ Guardando...';
      
      mostrarAlerta('‚è≥ Enviando a Google Sheets...', 'success');
      
      console.log('üöÄ Intentando guardar:', registrosPendientes);
      console.log('üìç URL:', CONFIG.WEB_APP_URL);
      
      try {
        const response = await fetch(CONFIG.WEB_APP_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'guardarProduccion',
            registros: registrosPendientes
          }),
          redirect: 'follow'
        });
        
        console.log('üì• Response status:', response.status);
        console.log('üì• Response type:', response.type);
        
        const textResponse = await response.text();
        console.log('üìÑ Response text:', textResponse);
        
        let data;
        try {
          data = JSON.parse(textResponse);
        } catch (e) {
          console.error('Error parseando JSON:', e);
          throw new Error('Respuesta no es JSON v√°lido');
        }
        
        console.log('üì¶ Data parsed:', data);
        
        if (data.success) {
          // Limpiar pendientes
          registrosPendientes = [];
          localStorage.removeItem('produccion_pendiente');
          
          // Actualizar UI
          actualizarLista();
          document.getElementById('formProduccion').reset();
          document.getElementById('producto').disabled = true;
          
          btnGuardar.disabled = false;
          btnGuardar.textContent = 'üíæ Guardar Todo';
          
          mostrarAlerta('‚úÖ ' + data.mensaje, 'success');
          
          // Redirigir al dashboard
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
        } else {
          throw new Error(data.error || 'Error desconocido');
        }
      } catch (error) {
        console.error('‚ùå Error completo:', error);
        
        btnGuardar.disabled = false;
        btnGuardar.textContent = 'üíæ Guardar Todo';
        
        mostrarAlerta('‚ùå Error: ' + error.message, 'error');
      }
    }
    
    function mostrarAlerta(mensaje, tipo) {
      const alert = document.getElementById('alert');
      alert.textContent = mensaje;
      alert.className = `alert alert-${tipo} show`;
      setTimeout(() => {
        if (!mensaje.includes('productos') && !mensaje.includes('Enviando')) {
          alert.classList.remove('show');
        }
      }, 5000);
    }
    
    function volver() {
      window.location.href = 'index.html';
    }
    
    // Inicializar lista al cargar
    actualizarLista();
  </script>
</body>
</html>
