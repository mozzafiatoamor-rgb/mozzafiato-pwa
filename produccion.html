<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar ProducciÃ³n - Mozzafiato</title>
  <script src="config.js"></script>
  <style>
    /* Copia TODOS los estilos del produccion.html anterior */
  </style>
</head>
<body>
  <!-- Copia TODO el HTML del produccion.html anterior -->
  
  <!-- Iframe oculto para API -->
  <iframe id="api-frame" style="display:none;"></iframe>
  
  <script>
    const productos = {
      'ProteÃ­na': ['Pollo', 'Arrachera', 'Carne de Hamburguesa', 'SalmÃ³n', 'CamarÃ³n'],
      'Salsa': ['Alfredo', 'Carbonara', 'BoloÃ±esa', 'Matriciana', 'Cuatro Quesos', 'Portobelo'],
      'Pasta': ['Fettuccini', 'Fusilli', 'LasaÃ±a']
    };
    
    let registrosPendientes = JSON.parse(localStorage.getItem('produccion_pendiente')) || [];
    let apiReady = false;
    
    // Cargar iframe de API
    const apiFrame = document.getElementById('api-frame');
    apiFrame.src = CONFIG.WEB_APP_URL + '?page=api';
    
    // Escuchar mensajes del iframe
    window.addEventListener('message', function(event) {
      if (event.data.type === 'api-ready') {
        apiReady = true;
        console.log('âœ… API lista');
      }
      
      if (event.data.type === 'produccion-guardada') {
        const result = event.data.result;
        const btnGuardar = document.getElementById('btnGuardar');
        
        btnGuardar.disabled = false;
        btnGuardar.textContent = 'ðŸ’¾ Guardar Todo';
        
        if (result.success) {
          registrosPendientes = [];
          localStorage.removeItem('produccion_pendiente');
          actualizarLista();
          document.getElementById('formProduccion').reset();
          document.getElementById('producto').disabled = true;
          
          mostrarAlerta('âœ… ' + result.mensaje, 'success');
          setTimeout(() => window.location.href = 'index.html', 2000);
        } else {
          mostrarAlerta('âŒ Error: ' + result.error, 'error');
        }
      }
    });
    
    // Resto del cÃ³digo igual (mostrar fecha, categorÃ­as, etc.)
    const hoy = new Date();
    const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('fechaHoy').textContent = hoy.toLocaleDateString('es-MX', opciones);
    
    const responsablesGuardados = JSON.parse(localStorage.getItem('responsables')) || [];
    const respList = document.getElementById('respList');
    responsablesGuardados.forEach(r => {
      const option = document.createElement('option');
      option.value = r;
      respList.appendChild(option);
    });
    
    document.getElementById('categoria').addEventListener('change', function() {
      const categoria = this.value;
      const selectProducto = document.getElementById('producto');
      selectProducto.innerHTML = '<option value="">Seleccionar producto...</option>';
      
      if (categoria && productos[categoria]) {
        productos[categoria].forEach(prod => {
          const option = document.createElement('option');
          option.value = prod;
          option.textContent = prod;
          selectProducto.appendChild(option);
        });
        selectProducto.disabled = false;
      } else {
        selectProducto.disabled = true;
      }
    });
    
    document.getElementById('formProduccion').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const registro = {
        turno: document.getElementById('turno').value,
        categoria: document.getElementById('categoria').value,
        producto: document.getElementById('producto').value,
        cantidad: parseInt(document.getElementById('cantidad').value),
        responsable: document.getElementById('responsable').value,
        notas: document.getElementById('notas').value
      };
      
      registrosPendientes.push(registro);
      localStorage.setItem('produccion_pendiente', JSON.stringify(registrosPendientes));
      
      if (!responsablesGuardados.includes(registro.responsable)) {
        responsablesGuardados.push(registro.responsable);
        localStorage.setItem('responsables', JSON.stringify(responsablesGuardados));
      }
      
      actualizarLista();
      document.getElementById('cantidad').value = '';
      document.getElementById('notas').value = '';
      mostrarAlerta('âœ… Producto agregado a la lista', 'success');
    });
    
    function actualizarLista() {
      const pendientesDiv = document.getElementById('pendientes');
      const lista = document.getElementById('listaPendientes');
      const contador = document.getElementById('contador');
      
      if (registrosPendientes.length > 0) {
        pendientesDiv.classList.add('show');
        contador.textContent = registrosPendientes.length;
        
        lista.innerHTML = registrosPendientes.map((r, i) => `
          <div class="pendiente-item">
            <div class="pendiente-info">
              <div class="pendiente-nombre">${r.producto}</div>
              <div class="pendiente-detalles">${r.cantidad} porciones | ${r.turno} | ${r.responsable}</div>
            </div>
            <button class="btn-eliminar" onclick="eliminar(${i})">âœ•</button>
          </div>
        `).join('');
      } else {
        pendientesDiv.classList.remove('show');
      }
    }
    
    function eliminar(index) {
      registrosPendientes.splice(index, 1);
      localStorage.setItem('produccion_pendiente', JSON.stringify(registrosPendientes));
      actualizarLista();
      mostrarAlerta('âŒ Producto eliminado de la lista', 'error');
    }
    
    function guardarTodos() {
      if (registrosPendientes.length === 0) {
        mostrarAlerta('âš ï¸ No hay productos para guardar', 'error');
        return;
      }
      
      if (!apiReady) {
        mostrarAlerta('â³ Esperando conexiÃ³n...', 'error');
        return;
      }
      
      const btnGuardar = document.getElementById('btnGuardar');
      btnGuardar.disabled = true;
      btnGuardar.textContent = 'â³ Guardando...';
      
      mostrarAlerta('â³ Enviando a Google Sheets...', 'success');
      
      // Enviar mensaje al iframe
      apiFrame.contentWindow.postMessage({
        action: 'guardarProduccion',
        registros: registrosPendientes
      }, '*');
    }
    
    function mostrarAlerta(mensaje, tipo) {
      const alert = document.getElementById('alert');
      alert.textContent = mensaje;
      alert.className = `alert alert-${tipo} show`;
      setTimeout(() => {
        if (!mensaje.includes('productos') && !mensaje.includes('Enviando')) {
          alert.classList.remove('show');
        }
      }, 5000);
    }
    
    function volver() {
      window.location.href = 'index.html';
    }
    
    actualizarLista();
  </script>
</body>
</html>
